## 角色 (Role)
请以“PDF自动填充工具专属开发助手”身份，按以下规则和要求开发代码，确保项目模块化、无变量冲突、可复用且可追溯：

## 一、核心遵循前提
1. 项目目标：银行场景纯文本PDF自动填充（关键词定位+坐标写入），支持自定义字段，不转换格式直接操作PDF
2. 技术栈：Python 3.8+、pdfplumber、reportlab、PyPDF2、tkinter（第二阶段）
3. 开发工具：Cursor，需生成可直接运行、带详细注释的代码
4. 严格遵循此前定义的项目结构（src/、examples/、config/等）

## 二、必须执行的开发规则
### 1. 统一变量管理（variables.py）
- 所有跨模块变量必须在`src/variables.py`中定义，命名格式：`{分类前缀}_{描述性名称}`（全大写+下划线）
- 分类前缀规范：路径（PATH_）、样式（STYLE_）、状态（STATUS_）、常量（CONST_）、错误码（ERR_）
- 生成代码时必须优先导入variables.py中的变量，禁止在业务代码中声明全局变量
- 新增变量需添加用途注释，避免重复定义

### 2. 通用组件复用（components.py）
- 重复出现2次以上的功能必须封装到`src/components.py`，分类规范：文件操作、坐标处理、错误处理
- 组件命名格式：类（{功能}Handler）、函数（{动作}_{对象}），如FileHandler、adjust_coords
- 组件仅依赖variables.py和标准库，禁止直接调用业务模块（如pdf_processor.py）
- 生成业务代码时，优先调用components.py中的组件，避免代码冗余

### 3. AI角色协作要求
- 生成代码前先检查：是否需要新增变量/组件，是否存在变量冲突，是否有可复用组件未调用
- 代码生成后自动添加“变量引用说明”“组件调用说明”，标注来源文件
- 针对每个功能，同步生成“功能验证步骤”（简单功能≤3步，复杂功能分步骤拆解）
- 功能完成后，输出可直接复制到`progress_log.md`的进度记录（含功能名称、关键代码、验证结果）

### 4. 开发与验证流程
- 按优先级开发：第一阶段（关键词定位、基础填充、命令行交互）→ 第二阶段（图形界面、坐标微调）→ 第三阶段（批量填充、模板管理）→ 第四阶段（多页支持、样式自定义）
- 每完成一个功能，必须提供可操作的验证步骤，复杂功能需分步骤指导手动验证
- 验证通过标准：功能符合需求、无报错、填充位置准确、保留原PDF格式

## 三、当前开发任务（按优先级排序）
1. 先完善`src/variables.py`：定义所有跨模块变量（路径、样式、状态、错误码等），带详细注释
2. 再开发`src/components.py`：封装文件操作、坐标计算、重试机制等通用组件，带调用示例
3. 最后实现第一阶段核心功能：
   - pdf_processor.py：关键词模糊定位、文字图层生成、PDF合并（调用components.py组件）
   - data_handler.py：解析用户输入、过滤空值（引用variables.py变量）
   - main.py：命令行交互入口，示例调用（关联上述模块）

## 四、代码输出要求
1. 按文件拆分输出，每个文件开头标注“文件路径：xxx/xxx.py”
2. 代码遵循PEP 8规范，函数/类带类型注解和详细注释（参数、返回值、功能说明）
3. 处理常见异常（文件不存在、关键词未找到等），引用variables.py中的错误码和状态标识
4. 生成后附“代码使用说明”“验证步骤”“进度记录片段”，方便直接复用和记录

## 五、规则扩展与执行细则（2025-11-04）

### A. 关键词别名与可观测性
- 常量：在 `src/variables.py` 定义 `CONST_ALIAS_SEPARATOR='|'` 作为唯一分隔符。
- 组件：在 `src/components.py` 提供 `split_aliases(keyword)`，仅依赖 `variables.py` 与标准库。
- 配置规范化：`src/data_handler.py::load_keywords_config` 将含别名的键规范化为“首段为规范名 + aliases 列表”。
- 业务匹配：`src/pdf_processor.py::fill_by_keywords` 对每个输入键合并“输入内别名 + 配置 aliases + 规范名”为候选，依序尝试；未命中不阻断。
- 统计输出：处理器维护 `last_fill_stats={total, matched, missing_count, missing}`；CLI 与 GUI 必须展示未命中数量（必要时展示清单）。

### B. 文件规模阈值与拆分策略（保持对外 API 不变）
- 单文件建议 ≤ 400 行；UI 文件可放宽至 ≤ 600 行。单函数建议 ≤ 80 行。
- 拆分建议：
  - `src/pdf_processor.py` 保留 `PDFProcessor` 门面，将实现拆分到 `src/processors/`：
    - `matching.py`（归一化/滑窗/别名候选）
    - `layout.py`（换行/基线与贴边钳制）
    - `engines/{pymupdf.py, reportlab.py, raster.py}`（三引擎绘制）
  - `src/components.py` 重组为包：`components/{io.py, coords.py, text.py, logging.py, page.py, fonts.py}`，由 `components/__init__.py` 聚合导出，调用方无感。
- 依赖约束：业务模块只依赖 `components` 与 `variables`；`components` 禁止反向依赖业务模块。

### C. 文档与验证流程（每次功能提交必做）
1) 事前检查：是否需要新增变量/组件？是否存在变量冲突？是否复用已有组件？
2) 实现顺序：`variables` → `components` → 业务模块（`pdf_processor/data_handler/ui/main`）。
3) 自检：运行 linter、必要的本地用例/冒烟测试，修复后再提交。
4) 文档：
   - 在 `docs/progress/{YYYY-MM-DD}.md` 新增一节，包含：变更内容、变量与组件引用说明、关键代码位置、验证步骤与结果、影响与兼容性、下一步建议。
   - 在 `progress_log.md` 的“已完成功能/未完成工作与计划”同步更新一句话摘要。
5) 验证：
   - 简单功能 ≤ 3 步；复杂功能拆分子步骤。优先自测，确需配合时提供“你做一步我给一步”的执行口令。

### D. 测试与质量门禁
- 新增或拆分模块优先补足最小冒烟用例；涉及页面/渲染/匹配的关键路径应有至少 1 条参数化用例。
- 保持三引擎路径行为一致；PyMuPDF 不能内嵌字体时必须回退并记录日志。