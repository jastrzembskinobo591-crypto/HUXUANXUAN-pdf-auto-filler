# 2025-11-02 项目记录

## 初始化与变量模块（已闭环）
- 功能：项目结构搭建与 `src/variables.py` 统一变量管理
- 关键代码：`src/variables.py`
- 验证结果：通过（变量可导入；`config/keywords.json` 存在且结构可读；`temp`/`output`/`logs` 目录可写）

## 第一阶段核心链路打通（关键词定位→图层生成→合并输出）（已闭环）
- 功能名称：通用组件与核心处理模块
  - 变量管理：完善 `src/variables.py`（路径/样式/状态/常量/错误码）
  - 通用组件：新增 `src/components.py`（日志、文件操作、坐标处理、重试）
  - 核心逻辑：新增 `src/pdf_processor.py`（`PDFProcessor.find_keyword_coordinates`/`fill_by_keywords`）
  - 数据处理：新增 `src/data_handler.py`（`load_keywords_config`、`sanitize_input_data`）
  - 入口：新增 `main.py`（CLI、示例 PDF 生成、填充命令）

- 变量引用说明（from `src/variables.py`）
  - 路径：`PATH_OUTPUT_DIR`、`PATH_TEMP_OVERLAY_PDF`、`PATH_LOG_FILE`、`PATH_FONT_FILE=C:\\Windows\\Fonts\\msyh.ttc`
  - 样式：`STYLE_OFFSET_X_DEFAULT=50.0`、`STYLE_OFFSET_Y_DEFAULT=0.0`、`STYLE_FONT_NAME=Helvetica`
  - 常量：`CONST_FUZZY_MATCH_THRESHOLD=0.60`、`CONST_DEFAULT_OUTPUT_SUFFIX="_filled.pdf"`
  - 错误码：`ERR_KEYWORD_NOT_FOUND=2001`、`ERR_TEXT_LAYER_BUILD_FAILED=2003`、`ERR_PDF_MERGE_FAILED=3001`

- 组件调用说明（from `src/components.py`）
  - 日志：`get_logger`（文件+控制台）
  - 文件：`FileHandler.validate_readable_file`、`FileHandler.ensure_parent_writable`、`timestamped_output_path`
  - 坐标：`right_of_bbox`、`adjust_coords`
  - 重试：`retry_on_exception`

- 配置与偏移
  - 字体：示例 PDF 与文本图层优先使用系统中文字体（微软雅黑）
  - 偏移：`config/keywords.json` 已调优 -> `offset_x=80`、`offset_y=-2`（两处关键词）

- 验证步骤与结果
  1. 创建并激活虚拟环境、安装依赖（通过）
  2. 组件冒烟测试：创建目录、打印坐标、写入日志（通过）
  3. 生成示例 PDF（中文字体）`examples/blank_contract.pdf`（通过）
  4. 执行填充命令，输出到 `output/blank_contract_YYYYMMDD_HHMMSS_filled.pdf`（通过）
  5. 偏移微调：`offset_x=80`、`offset_y=-2` 后位置更贴近标签（通过）

- 关键代码位置
  - `src/pdf_processor.py::PDFProcessor.find_keyword_coordinates`
  - `src/pdf_processor.py::PDFProcessor.fill_by_keywords`
  - `src/components.py::FileHandler`, `right_of_bbox`, `adjust_coords`, `get_logger`
  - `src/data_handler.py::load_keywords_config`, `sanitize_input_data`
  - `main.py`（CLI、示例 PDF 生成）

- 结论
  - 第一阶段最小闭环完成：关键词定位 → 文字图层生成 → 合并输出
  - 示例 PDF 与中文字体配置已就绪，中文识别与填充可用

- 下一步建议（按优先级）
  1. 多页支持：接口保持不变，扩展为遍历页/指定页集合
  2. 批量填充：支持读取一组 JSON/CSV 进行多份输出
  3. 模板管理：按文件名或模板 ID 选择不同关键词集与偏移
  4. GUI（第二阶段）：`tkinter` 选择文件、可视化微调 offset

## 稳定性与规范修复（临时文件清理、错误码修正、IO 重试、文档说明）（已闭环）
- 变更内容
  - 合并完成后按 `CONST_CLEAN_TEMP_ON_EXIT` 自动清理 `temp/overlay_layer.pdf`
  - 页码越界日志错误码改为 `ERR_PAGE_INDEX_OUT_OF_RANGE`
  - 为 `_build_text_layer` 与 `_merge_pdfs` 增加 `@retry_on_exception()`（指数退避重试）
  - 在 `src/pdf_processor.py`、`src/components.py`、`src/data_handler.py`、`main.py` 顶部补充“变量引用说明/组件调用说明”

- 关键代码位置
  - `src/pdf_processor.py::PDFProcessor.find_keyword_coordinates`（越界使用 `ERR_PAGE_INDEX_OUT_OF_RANGE`）
  - `src/pdf_processor.py::PDFProcessor.fill_by_keywords`（合并后按配置清理 `PATH_TEMP_OVERLAY_PDF`）
  - `src/pdf_processor.py::_build_text_layer`（`@retry_on_exception()`）
  - `src/pdf_processor.py::_merge_pdfs`（`@retry_on_exception()`）

- 验证步骤与结果
  1. `python main.py --make-example` 生成示例 PDF（通过）
  2. `python main.py` 执行填充，输出至 `output/`（通过）
  3. 执行后检查 `temp/` 目录，默认不残留 `overlay_layer.pdf`（通过）
  4. 人为设置越界页（例如配置中写入 `page=99`），日志出现 `ERR_PAGE_INDEX_OUT_OF_RANGE` 告警，程序不中断（通过）

- 影响与兼容性
  - 行为兼容：对外接口不变；失败时自动重试提升稳定性；日志更准确；临时文件默认清理（可通过 `CONST_CLEAN_TEMP_ON_EXIT` 关闭）

- 后续建议（保持与阶段目标一致）
  - 可选：在绘制前对 `(x, y)` 应用 `clamp_coords` 进行越界保护
  - 跟进：多页支持、批量填充、模板管理、GUI（第二阶段）

## GUI 首版与中文字体显示问题排查（未闭环）
- 功能/变更
  - 新增 `src/ui.py`（tkinter）：文件选择、字段增删、模板保存/加载、执行填充、打开输出目录
  - `main.py` 增加 `--gui` 入口；`requirements.txt` 新增 `pymupdf` 以支持直接写字引擎
  - `src/pdf_processor.py` 新增 PyMuPDF 引擎：`_fill_with_pymupdf`（直接在原 PDF 上写字，尝试内嵌字体）
  - `src/variables.py` 完善 GUI/字体相关常量；`PATH_FONT_FILE` 当前指向 `config/fonts/simhei.ttf`

- 关键代码
  - `src/ui.py::PdfFillerApp`（GUI 主体）
  - `src/pdf_processor.py::PDFProcessor.fill_by_keywords(..., engine="pymupdf")`
  - `src/pdf_processor.py::_fill_with_pymupdf`（内嵌字体 + 写字）

- 现象与结论（问题未闭环）
  - 在 WPS 打开输出 PDF 时，中文显示为黑块；输出文件体积≈1–2 KB，明显偏小
  - 推断：字体未真正嵌入或被阅读器忽略；需要强制嵌入与保存参数强化，或改用图片叠加兜底

- 已尝试的修复
  1. ReportLab 路线：注册系统/外部字体（TTF/OTF/TTC），回退 CID 字体；仍被 WPS 显示为黑块
  2. PyMuPDF 路线：`doc.insert_font(file=...) + page.insert_text(fontname=...)`；保存时 `deflate`，但文件体积仍过小
  3. 字体资源：下载 `NotoSansCJKsc-Regular.otf` 与复制 `C:\\Windows\\Fonts\\simhei.ttf` 至 `config/fonts/` 并指向使用；仍未生效

- 待解决的技术要点（下一步）
  1. PyMuPDF 强制内嵌与保存参数：
     - 使用固定 `fontname`（如 "SimHei"），`doc.insert_font(file=..., fontname="SimHei")`，写字时仅传 `fontname`
     - 保存：`doc.save(out, deflate=True, clean=True, garbage=4)`
     - 增加调试：检查资源与 `doc.has_embedded_fonts()`，打印日志确认嵌入成功与输出体积
  2. 兜底方案（兼容模式）：
     - Pillow 将文本渲染为透明 PNG，再贴回 PDF（文字不可选但 100% 显示）
  3. GUI 增强：
     - 在 GUI 增加“渲染引擎选择（pymupdf/reportlab/raster）”与“显示输出文件大小”提示

- 面向下次的验证步骤
  1. `python main.py --gui` 启动；在 GUI 点击“执行填充”
  2. 观察 `output/` 最新 `_filled.pdf`：文件体积应显著增大（通常≥30 KB）
  3. 用 WPS/Edge/Adobe Reader 打开对比；若 WPS 仍异常，切换到“兼容模式（图片叠加）”验证

- 影响范围
  - 接口兼容；新增 PyMuPDF 依赖。问题仅影响中文显示，关键词定位与输出链路正常

