# 2025-11-03 项目记录

## 基线对齐与坐标精调（已闭环）
- 变更内容
  - 对齐策略：新增基线锚点 `right_of_bbox_baseline`，以 pdfplumber 的 bottom 作为 y 基线，确保与标签冒号水平对齐
  - 引擎稳定性：当 PyMuPDF 不支持 `insert_font` 时，自动回退至 ReportLab+PyPDF2 合成路径；保存使用 `clean=True, garbage=4, deflate=True` 并记录输出体积日志
  - 偏移校准：结合可视反馈逐步微调，最终 `config/keywords.json` 为 `offset_x=2`、`offset_y=2`（"身份证号："“企业名称：”）

- 变量引用说明（from `src/variables.py`）
  - 路径/字体：`PATH_FONT_FILE`、`CONST_CANDIDATE_CJK_FONT_PATHS`
  - 样式：`STYLE_FONT_NAME_CJK_PREFERRED`、`STYLE_FONT_SIZE_DEFAULT`、`STYLE_TEXT_COLOR_RGB`
  - 常量：`CONST_CLEAN_TEMP_ON_EXIT`

- 组件调用说明（from `src/components.py`）
  - `right_of_bbox_baseline`（基线锚点）、`adjust_coords`（偏移计算）、`FileHandler.ensure_parent_writable`（输出保障）、`get_logger`（日志）

- 关键代码位置
  - `src/components.py::right_of_bbox_baseline`
  - `src/pdf_processor.py::PDFProcessor.find_keyword_coordinates`（使用基线锚点）
  - `src/pdf_processor.py::_fill_with_pymupdf`（不能内嵌时回退合成路径 + 强化保存参数）
  - `config/keywords.json`（最终偏移：x=2, y=2）

- 验证步骤与结果
  1. `python main.py --make-example` 生成示例 PDF（中文关键词可识别）
  2. `python main.py --input examples/blank_contract.pdf` 执行填充（若 PyMuPDF 不支持内嵌则自动回退）
  3. 用 WPS/Edge/Adobe Reader 打开：中文正常、可选中复制；与“：”同一水平线；输出体积正常（非 1–2 KB）

- 结论
  - WPS 显示与基线对齐问题已闭环；当前默认配置可直接用于银行场景示例表单

- 下一步建议（与阶段目标一致）
  1. 多页支持：遍历页/指定页集合（保持接口不变）
  2. 兼容模式：图片叠加渲染兜底（确保任意阅读器一致显示）
  3. 批量填充与模板管理：按模板 ID/文件名选择关键词集与偏移
  4. GUI 增强：引擎选择、输出体积提示与坐标可视化微调

## 多页支持（页集合选择 + 跨页搜索）（已闭环）
- 变更内容
  - 新增页选择解析：`src/components.py::parse_page_selection`
  - 扩展处理器：`src/pdf_processor.py::PDFProcessor.fill_by_keywords(..., pages=...)`
  - CLI 增参：`main.py::--pages`（支持 'all' 与 '1,3-5'，1 基）
  - 变量：`src/variables.py::CONST_PAGE_SELECTION_ALL/AUTO`

- 变量引用说明（from `src/variables.py`）
  - `CONST_PAGE_INDEX_DEFAULT`、`CONST_PAGE_SELECTION_ALL`、`CONST_PAGE_SELECTION_AUTO`

- 组件调用说明（from `src/components.py`）
  - `parse_page_selection`、`FileHandler`、`get_logger`、`adjust_coords`、`right_of_bbox_baseline`

- 验证步骤与结果
  1. 生成两页样例：`examples/blank_contract_2pages.pdf`（2 页）
  2. 临时移除 `config/keywords.json` 的 `page` 字段，仅保留 `offset_x/offset_y`
  3. 运行 `--pages 2`：仅第 2 页填充（第 1 页不填），通过
  4. 运行 `--pages all`：在选定集合中命中最先出现的页（第 1 页），第 2 页不重复写入，通过

- 关键输出
  - `output/blank_contract_2pages_YYYYMMDD_HHMMSS_filled.pdf`

- 影响范围
  - 接口向后兼容；未提供 `--pages` 时保持默认仅搜索第 1 页

- 下一步建议（保持与阶段目标一致）
  - 兼容模式：图片叠加渲染兜底（任意阅读器一致显示）
  - 批量填充与模板管理：按模板 ID/文件名选择关键词集并批量生成
  - GUI 增强：引擎选择、输出体积提示与坐标可视化微调

## 兼容模式（图片叠加栅格化兜底）（已闭环）
- 变更内容
  - 新增 Raster 引擎：`src/pdf_processor.py::_fill_with_raster` 使用 Pillow 将文字渲染为透明 PNG，并通过 PyMuPDF `page.insert_image` 贴回原 PDF，实现 100% 显示一致的兜底方案（文字不可选中）
  - 引擎接入：`PDFProcessor.fill_by_keywords(..., engine='raster')`；CLI 增参 `--engine {pymupdf,reportlab,raster}`，默认 `pymupdf`，可按需切换
  - 新变量：`src/variables.py` 新增 `STYLE_RASTER_TEXT_ALPHA`（文字透明度）、`CONST_RASTER_SCALE`（渲染比例）
  - 依赖：`requirements.txt` 新增 `Pillow==10.3.0`

- 变量引用说明（from `src/variables.py`）
  - 样式：`STYLE_RASTER_TEXT_ALPHA`、`STYLE_FONT_SIZE_DEFAULT`、`STYLE_TEXT_COLOR_RGB`
  - 常量/路径：`CONST_RASTER_SCALE`、`PATH_FONT_FILE`、`CONST_CANDIDATE_CJK_FONT_PATHS`

- 组件调用说明（from `src/components.py`）
  - `FileHandler.ensure_parent_writable`（输出保障）、`get_logger`（日志）

- 关键代码位置
  - `src/pdf_processor.py::_fill_with_raster`
  - `src/pdf_processor.py::PDFProcessor.fill_by_keywords(..., engine='raster')`
  - `main.py::--engine`
  - `src/variables.py`（新增常量）

- 验证步骤与结果
  1. 安装依赖：`pip install -r requirements.txt`（通过；Pillow 10.3.0 安装成功）
  2. 生成示例：`python main.py --make-example`（通过）
  3. 执行填充：`python main.py --engine raster --input examples/blank_contract.pdf --pages all`（通过）
  4. 结果检查：输出文件体积≈13 KB；WPS/Edge/Adobe 显示中文正常；与“：”同一水平线；文字不可选中（符合 raster 预期）

- 影响与兼容性
  - 接口向后兼容；默认仍为 `pymupdf` 引擎，`raster` 作为兜底确保任意阅读器一致显示
  - `raster` 模式文字不可复制，这是预期取舍；如需可复制文本，可继续使用 `pymupdf` 或 ReportLab 合成路径

- 下一步建议
  1. 批量填充：读取 JSON/CSV 多份数据批量输出（结合模板选择）
  2. 模板管理：按模板 ID/文件名选择不同关键词集与偏移
  3. GUI 增强：引擎选择下拉、输出体积提示、可视化坐标微调

## 批量填充与模板管理（已闭环）
- 变更内容
  - 批量数据加载：新增 `src/data_handler.py::load_batch_json`、`load_batch_csv`（包含 UTF-8 BOM 兼容解析）
  - 模板索引：新增 `src/data_handler.py::load_templates_index`；新增 `config/templates.json` 管理 模板 ID -> 关键词配置 路径映射
  - CLI 扩展：`main.py` 新增 `--batch-json/--batch-csv/--batch-output-dir/--template-id/--keywords-json`；批量模式优先，单次模式保持原接口
  - 批量输出命名：`src/components.py::FileHandler.indexed_output_path` 生成带时间戳与序号的文件名（例如 `_001_filled.pdf`）
  - 示例模板：新增 `config/keywords_bank_b.json`（偏移更大，便于观察模板切换）

- 变量引用说明（from `src/variables.py`）
  - `CONST_ENCODING`、`PATH_TEMPLATES_JSON`、`PATH_KEYWORDS_JSON`

- 组件调用说明（from `src/components.py`）
  - `FileHandler.indexed_output_path`、`get_logger`

- 关键代码位置
  - `src/components.py::FileHandler.indexed_output_path`
  - `src/data_handler.py::load_batch_json`、`load_batch_csv`、`load_templates_index`、`_json_loads_strip_bom`
  - `main.py`：`--batch-json/--batch-csv/--batch-output-dir/--template-id/--keywords-json`
  - 配置：`config/templates.json`、`config/keywords_bank_b.json`

- 验证步骤与结果
  1. `python main.py --make-example` 生成示例（通过）
  2. `--batch-json examples/batch.json` 生成两份（通过；约 19 KB/份）
  3. `--template-id bank_b` 位置明显更靠右（通过）
  4. `--keywords-json config/keywords.json` 覆盖模板恢复默认偏移（通过）
  5. `--batch-csv examples/batch.csv` 生成两份（通过）
  6. 阅读器验证：WPS/Edge/Adobe 中文正常、与“：”同一水平线（通过）

- 影响与兼容性
  - 向后兼容：未提供批量参数时行为不变；新增选项不破坏既有接口
  - 稳定性：对 JSON 加载增加 UTF-8 BOM 兼容；PyMuPDF 内嵌失败自动回退 ReportLab+PyPDF2

- 下一步建议
  1. GUI 增强：在 `src/ui.py` 接入批量/模板选择、引擎下拉、输出体积提示与坐标可视化微调
  2. 输出命名增强：支持自定义前缀与序号宽度（CLI 选项）
  3. 模板管理完善：支持按输入文件名自动匹配模板 ID

## 输出命名增强（已闭环）
- 变更内容
  - 新增常量：`CONST_OUTPUT_PREFIX_DEFAULT`、`CONST_INDEX_PAD_WIDTH_DEFAULT`（`src/variables.py`）
  - 扩展组件：`FileHandler.timestamped_output_path(prefix=...)`、`FileHandler.indexed_output_path(prefix=..., pad=...)`（`src/components.py`）
  - CLI 新增：`--output-prefix`（覆盖文件名前缀）、`--index-width`（批量序号宽度），单次与批量均生效（`main.py`）

- 变量引用说明（from `src/variables.py`）
  - `CONST_OUTPUT_PREFIX_DEFAULT`：默认输出前缀（空表示沿用源文件名 stem）
  - `CONST_INDEX_PAD_WIDTH_DEFAULT`：批量输出序号零填充宽度（默认 3）
  - `CONST_DEFAULT_OUTPUT_SUFFIX`：输出文件名后缀（默认 `_filled.pdf`）

- 组件调用说明（from `src/components.py`）
  - `FileHandler.timestamped_output_path(input_pdf, suffix, prefix)`：支持传入 `prefix` 覆盖 stem
  - `FileHandler.indexed_output_path(input_pdf, index, suffix, pad, prefix)`：支持 `prefix` 与 `pad` 自定义

- 关键代码位置
  - `src/variables.py`：新增输出命名相关常量
  - `src/components.py::FileHandler.timestamped_output_path`、`indexed_output_path`：新增参数与逻辑
  - `main.py::parse_args`、`main.py::main`：CLI 参数与调用接入点

- 验证步骤与结果
  1. 单次模式：`python main.py --input examples/blank_contract.pdf --output-prefix mydoc --kv "身份证号：=1234567890" --kv "企业名称：=某某科技"` → `output/mydoc_YYYYMMDD_HHMMSS_filled.pdf`
  2. 批量 JSON：`python main.py --input examples/blank_contract.pdf --batch-json examples/batch.json --output-prefix rpt --index-width 2` → `..._01_filled.pdf`、`..._02_filled.pdf`
  3. 批量 CSV + 自定义目录：`python main.py --input examples/blank_contract.pdf --batch-csv examples/batch.csv --output-prefix rptcsv --index-width 2 --batch-output-dir output/csv_out` → 文件写入 `output/csv_out/`

- 影响与兼容性
  - 完全向后兼容：未提供新参数时行为不变；新增参数仅增强命名可控性

- 下一步建议（为后续开发准备）
  1. 模板管理增强：按输入 PDF 文件名自动匹配模板 ID（减少 CLI 选项输入）
  2. GUI 增强：在 `src/ui.py` 暴露前缀与序号宽度输入框，并展示输出目录链接
  3. 单测补充：为 `FileHandler.indexed_output_path` 增加参数化用例（前缀与 pad 组合）

## 模板自动匹配（按输入文件名推断模板 ID）（已闭环）
- 变更内容
  - 新增 `src/data_handler.py::infer_template_id_from_filename`：未显式指定 `--keywords-json` 与 `--template-id` 时，基于输入 PDF 文件名自动匹配模板 ID
  - 接入点：`main.py` 在选择关键词配置路径时优先级为 `--keywords-json` > `--template-id` > 自动匹配（文件名） > 默认配置
  - `config/templates.json` 兼容新旧两种结构（旧结构 `{"bank_b": "config/keywords_bank_b.json"}`；新结构 `{"bank_b": {"path": "config/keywords_bank_b.json", "match_patterns": ["bank_b", "合同B"]}}`）

- 变量引用说明（from `src/variables.py`）
  - `PATH_TEMPLATES_JSON`、`CONST_ENCODING`、`ERR_CONFIG_LOAD_FAILED`

- 组件调用说明（from `src/components.py`）
  - `get_logger`

- 关键代码位置
  - `src/data_handler.py::infer_template_id_from_filename`
  - `src/data_handler.py::load_templates_index`（兼容新旧结构）
  - `main.py`（关键词配置选择逻辑）

- 验证步骤与结果
  1. 复制示例：`Copy-Item examples/blank_contract.pdf examples/bank_b_contract.pdf`
  2. `python main.py --input examples/bank_b_contract.pdf --kv "身份证号：=1234567890" --kv "企业名称：=某某科技"` → 日志显示自动匹配 `template_id=bank_b`
  3. 默认模板对照：`python main.py --input examples/blank_contract.pdf ...` → 未触发自动匹配
  4. 结果对比：`output/` 中两份 PDF 体积≈19 KB；`bank_b` 输出更靠右，与“：”同一基线

- 影响与兼容性
  - 完全向后兼容；未提供新参数时自动提升易用性；明确优先级避免歧义

- 下一步建议
  1. 在 GUI 中展示“自动匹配模板 ID（可覆盖）”，并允许编辑 `match_patterns`
  2. 增加单测：文件名 -> 模板 ID 推断（含新旧结构、冲突消解、无匹配回退）
  3. 在批量模式中按输入文件名分别自动匹配模板（可选开关）

## GUI 选项验证 + PyMuPDF 内嵌与 Raster 清晰度提升（已闭环）
- 变更与确认
  - GUI：左侧新增“选项”卡（引擎下拉/页选择/输出前缀），右侧新增“输出文件大小”实时显示（`src/ui.py`）
  - 示例生成：`src/ui.py::_on_make_example` 优先使用 PyMuPDF 嵌入 TTF/OTF 生成示例；若失败回退 ReportLab（保留日志提示）
  - PyMuPDF 路线：`src/pdf_processor.py::_fill_with_pymupdf` 强化字体内嵌与保存参数，失败时自动回退合成路径
  - Raster 清晰度：`src/variables.py::CONST_RASTER_SCALE` 提升至 `2.0`，使位图文本更清晰（体积可接受）

- 变量引用说明（from `src/variables.py`）
  - 路径/字体：`PATH_FONT_FILE`、`CONST_CANDIDATE_CJK_FONT_PATHS`
  - 样式：`STYLE_FONT_SIZE_DEFAULT`、`STYLE_TEXT_COLOR_RGB`
  - 常量：`CONST_RASTER_SCALE=2.0`、`CONST_OUTPUT_PREFIX_DEFAULT`、`CONST_INDEX_PAD_WIDTH_DEFAULT`

- 组件调用说明（from `src/components.py`）
  - `FileHandler.timestamped_output_path/indexed_output_path/ensure_parent_writable`
  - `parse_page_selection`、`get_logger`

- 验证步骤与结果
  1. 单次填充（pymupdf）：`examples/blank_contract_2pages.pdf` → 输出≈21 KB，中文可复制，页选择 2 时仅第 2 页写入
  2. 批量 JSON（pymupdf）：`--batch-json examples/batch.json --engine pymupdf --pages all` → `_01/_02_filled.pdf`，20–21 KB
  3. 批量 CSV（pymupdf）：`--batch-csv examples/batch.csv --batch-output-dir output/csv_out --engine pymupdf --pages all` → 输出≈20 KB
  4. Raster 兜底：GUI 选 `engine=raster`、`pages=all`、前缀 `raster_x2` → 输出≈21 KB，文字清晰不可选中

- 现象与结论
  - `examples/blank_contract.pdf` 因未嵌入中文字体，WPS 显示黑块；实际填充使用 `blank_contract_2pages.pdf` 可正常写入
  - 若环境缺少 `insert_font`，处理器自动回退 ReportLab+PyPDF2，功能不受阻

- 已知问题与待办（下次迭代优先级）
  1. 自动换行：计划在配置新增 `max_width/line_spacing`
  2. GUI 增强：引擎提示、输出体积提示、清晰度滑杆
  3. 版本兼容：启动日志输出 PyMuPDF 版本与 `insert_font` 可用性
  4. 单元测试：补充 `parse_page_selection`、`FileHandler.indexed_output_path`、批量 CSV/JSON、模板自动匹配用例

## 自动换行（按宽度分行 + 行距）（已闭环）
- 变更内容
  - 三引擎接入自动换行：在 `pymupdf`、`reportlab`、`raster` 路径统一支持 `max_width/line_spacing`
  - 新数据结构：`src/pdf_processor.py::DrawText`（包含 `text/x/y/max_width/line_spacing`）
  - 新方法：`src/pdf_processor.py::_wrap_text_lines` 使用 ReportLab 字体度量进行宽度估计，跨引擎一致
  - 配置：`config/keywords.json` 为“身份证号：”“企业名称：”新增 `max_width/line_spacing` 示例

- 变量引用说明（from `src/variables.py`）
  - 样式：`STYLE_LINE_SPACING`、`STYLE_FONT_SIZE_DEFAULT`、`STYLE_TEXT_COLOR_RGB`
  - 其他：`PATH_FONT_FILE`、`CONST_CANDIDATE_CJK_FONT_PATHS`

- 组件调用说明（from `src/components.py`）
  - `FileHandler.ensure_parent_writable`、`get_logger`、`parse_page_selection`

- 关键代码位置
  - `src/pdf_processor.py::DrawText`
  - `src/pdf_processor.py::PDFProcessor._wrap_text_lines`
  - `src/pdf_processor.py::PDFProcessor._build_text_layer/_fill_with_pymupdf/_fill_with_raster`

- 验证步骤与结果
  1. 在 `config/keywords.json` 增加 `max_width/line_spacing`（身份证号 180/14，企业名称 220/14）
  2. `python .\main.py --input .\examples\blank_contract_2pages.pdf --kv "身份证号：=123456789012345678901234567890" --kv "企业名称：=某某超长科技股份有限公司（含非常非常非常长的名称段）" --pages all --output-prefix wrap_test`
  3. 结果：输出 `output/wrap_test_YYYYMMDD_HHMMSS_filled.pdf`；自动换行、行距均匀、基线对齐；体积≈22.2 KB

- 影响与兼容性
  - 完全向后兼容：未配置 `max_width` 时保持单行；`line_spacing` 省略时使用 `STYLE_LINE_SPACING`
  - 三引擎行为一致；PyMuPDF 若无法内嵌字体将自动回退 ReportLab 合成路径

## 单元测试补齐（components & data_handler）（已闭环）
- 变更内容
  - 新增测试：
    - `tests/test_components_pages.py`（页选择解析）
    - `tests/test_components_output_naming.py`（输出命名）
    - `tests/test_data_handler_batch.py`（批量 JSON/CSV 加载，含 UTF-8 BOM 兼容）
    - `tests/test_data_handler_templates.py`（模板索引新/旧结构与按文件名自动匹配）
  - 测试环境：新增 `tests/conftest.py` 自动将项目根加入 `sys.path`

- 变量引用说明（from `src/variables.py`）
  - `PATH_OUTPUT_DIR`、`CONST_DEFAULT_OUTPUT_SUFFIX`、`CONST_INDEX_PAD_WIDTH_DEFAULT`、`PATH_TEMPLATES_JSON`、`CONST_ENCODING`

- 组件调用说明（from `src/components.py`）
  - `parse_page_selection`、`FileHandler.timestamped_output_path/indexed_output_path`、`get_logger`

- 验证步骤与结果
  1. `pytest -q tests/test_components_pages.py`
  2. `pytest -q tests/test_components_output_naming.py`
  3. `pytest -q tests/test_data_handler_batch.py`
  4. `pytest -q tests/test_data_handler_templates.py`
  5. `pytest -q` 汇总：16 passed

- 影响与兼容性
  - 仅新增测试文件，不影响运行时行为；为后续改动提供回归保障

- 下一步建议
  - 为长文本换行与坐标钳制补充参数化用例；在 CI 中接入 pytest

## 端到端冒烟验证（pymupdf 回退 & raster 兜底）（已闭环）
- PyMuPDF 路线（自动回退 ReportLab 合成）：
  - 命令：`python .\main.py --input .\examples\blank_contract_2pages.pdf --kv '身份证号：=12345678901234567890' --kv '企业名称：=某某科技有限公司' --pages all --engine pymupdf --output-prefix e2e_pymupdf`
  - 输出：`output/e2e_pymupdf_YYYYMMDD_HHMMSS_filled.pdf`，体积≈20.8 KB
  - 现象：中文正常、可选中复制；与“：”同一水平基线；日志提示 `insert_font` 不可用，已回退合成路径
- Raster 兜底：
  - 命令：`python .\main.py --input .\examples\blank_contract_2pages.pdf --kv '身份证号：=12345678901234567890' --kv '企业名称：=某某科技有限公司' --pages all --engine raster --output-prefix e2e_raster`
  - 输出：`output/e2e_raster_YYYYMMDD_HHMMSS_filled.pdf`，体积≈21.4 KB
  - 现象：中文正常、与“：”同一基线；文字不可选中（符合 raster 设计取舍）

- 变量引用说明（from `src/variables.py`）
  - `STYLE_FONT_SIZE_DEFAULT`、`STYLE_LINE_SPACING`、`STYLE_TEXT_COLOR_RGB`、`CONST_RASTER_SCALE`、`PATH_OUTPUT_DIR`

- 组件调用说明（from `src/components.py`）
  - `parse_page_selection`、`FileHandler.ensure_parent_writable/timestamped_output_path`、`get_logger`

- 影响与兼容性
  - 三引擎可用；在不支持 `insert_font` 的环境下自动回退，确保功能不中断；raster 确保任意阅读器一致显示

- 下一步建议
  - GUI 增强：暴露 `CONST_RASTER_SCALE` 滑杆与输出大小提示；启动时输出 PyMuPDF 版本与 `insert_font` 可用性

## 启动日志能力 + 全链路复核（已闭环）
- 变更内容
  - 新增开关常量：`src/variables.py::CONST_LOG_PYMUPDF_CAPABILITIES_ON_STARTUP=True`
  - 启动能力日志：`main.py::_log_runtime_capabilities` 输出 PyMuPDF 版本与 `Document.insert_font` 可用性；在 `main()` 开始即打印

- 变量引用说明（from `src/variables.py`）
  - `CONST_LOG_PYMUPDF_CAPABILITIES_ON_STARTUP`

- 组件调用说明（from `src/components.py`）
  - `get_logger`

- 关键代码位置
  - `main.py::_log_runtime_capabilities`
  - `src/variables.py::CONST_LOG_PYMUPDF_CAPABILITIES_ON_STARTUP`

- 验证步骤与结果
  1. 启动日志：`python main.py --make-example` → 控制台/日志输出 `运行环境：PyMuPDF version=1.24.9, Document.insert_font=False`
  2. 单次填充（pymupdf，自动回退）：`--engine pymupdf --output-prefix e2e_pymupdf`
  3. Raster 兜底：`--engine raster --output-prefix e2e_raster`
  4. 批量 JSON：`--batch-json examples/batch.json --output-prefix rpt --index-width 2 --pages all`
  5. 模板自动匹配：`--input examples/bank_b_contract.pdf --output-prefix bankb_auto`
  6. 批量 CSV + 自定义目录：`--batch-csv examples/batch.csv --batch-output-dir output/csv_out --output-prefix rptcsv --index-width 2`

- 影响与兼容性
  - 能力日志仅增强可观测性，不改变核心接口；三引擎路径、批量与模板管理行为均保持向后兼容

- 下一步建议
  - GUI 增强：暴露引擎下拉、页选择、输出前缀与清晰度滑杆；显示输出文件大小
  - 单测补充：自动换行与坐标钳制、模板自动匹配边界用例；引入 CI
  - 启动诊断完善：首行日志输出 PyMuPDF 版本、`insert_font` 能力、字体探测结果
  - 模板管理增强：批量模式下按文件名自动匹配模板（可开关），并在 GUI 中编辑 `match_patterns`

## 坐标钳制增强与批量回归（已闭环）
- 变更内容
  - 新增 `src/components.py::clamp_baseline`：基线感知钳制，考虑上升/下降线，防止靠近页顶/底被裁剪
  - 右侧可见性保护：三引擎绘制前基于字体度量计算行宽，限制 x 避免越过右边界
  - 三引擎接入：ReportLab、PyMuPDF、Raster 路径同步钳制
  - 修复 `config/keywords.json` 重复块导致的 `Extra data` 解析错误

- 变量引用说明（from `src/variables.py`）
  - `CONST_CLAMP_MARGIN_DEFAULT=2.0`、`STYLE_FONT_SIZE_DEFAULT`、`STYLE_LINE_SPACING`、`STYLE_TEXT_COLOR_RGB`

- 组件调用说明（from `src/components.py`）
  - `clamp_baseline`、`clamp_coords`、`parse_page_selection`、`FileHandler.ensure_parent_writable/indexed_output_path/timestamped_output_path`、`get_logger`

- 关键代码位置
  - `src/components.py::clamp_baseline`
  - `src/pdf_processor.py::_build_text_layer`
  - `src/pdf_processor.py::_fill_with_pymupdf`
  - `src/pdf_processor.py::_fill_with_raster`
  - `config/keywords.json`

- 验证步骤与结果
  1. 极端偏移贴边验证：`offset_x±5000`、`offset_y±2000` → 文本贴边但不越界
  2. 常规配置回归：恢复 `offset_x=2/offset_y=2` → 与“：”同一基线
  3. 批量 JSON：`--batch-json examples/batch.json --engine pymupdf --pages all`
  4. 批量 CSV + 自定义目录：`--batch-csv examples/batch.csv --batch-output-dir output/csv_out --engine pymupdf --pages all`

- 影响与兼容性
  - 完全向后兼容；异常偏移不再越界，靠右文本保持完整；配置修复后加载稳定

- 下一步建议
  - GUI 增强：在 `ui.py` 中增加贴边保护开关/边距调整、输出体积提示
  - 单测补充：为 `clamp_baseline` 与右侧可见性添加参数化测试
  - 启动诊断：输出选用字体及度量来源

