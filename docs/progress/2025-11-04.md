# 2025-11-04 项目记录

## 专家模式参数贯通：模糊阈值 + CLI/GUI（已闭环）
- 变更内容
  - 处理器：`src/pdf_processor.py::PDFProcessor.fill_by_keywords` 新增参数 `fuzzy_threshold`，向下传递至 `find_keyword_coordinates(..., fuzzy_threshold=...)`，默认回退 `CONST_FUZZY_MATCH_THRESHOLD`。
  - CLI：`main.py::parse_args` 新增 `--fuzzy-threshold`；单次与批量分支在调用处理器时传递该参数。
  - GUI（专家模式）：左侧“选项”卡新增“模糊阈值(0~1)”输入框；执行分支将其解析为浮点并传入处理器。

- 变量与组件引用说明
  - 变量：`src/variables.py::CONST_FUZZY_MATCH_THRESHOLD`（默认值）；页选择沿用 `parse_page_selection`（已有）。
  - 组件：复用 `components.page.parse_page_selection`；其余为参数透传，无新增组件依赖。

- 关键代码位置
  - `src/pdf_processor.py::PDFProcessor.fill_by_keywords`（参数+传递）
  - `main.py::parse_args/单次与批量分支`（CLI 参数）
  - `src/ui.py::_build_left_config/_on_execute_fill`（GUI 输入与传递）

- 验证步骤与结果
  1. CLI：默认阈值 0.6，`企业名：`≈`企业名称：` → 命中；提升至 0.95 → 未命中 1 项（企业名）✓
  2. GUI：专家模式阈值=0.95 → “未找到关键词：1”；改回 0.6 → “未找到关键词：0”✓
  3. 自动化测试：新增用例
     - `tests/test_matching_threshold.py`（参数化 0.6 / 0.95）→ 2 passed
     - `tests/test_ui_missing_count.py`（GUI 未命中计数，headless 消息框打桩）→ 本地可运行

- 影响与兼容性
  - 向后兼容：未显式传入阈值时行为不变；仅增强可调性与可观测性。

- 下一步建议
  - 扩展参数化测试覆盖别名与页范围 all 的组合；在 CI 接入 pytest。

## 最小重构：components 包化 + processors 占位（对外无感，零业务变更）
- 变更内容
  - 将原单文件 `src/components.py` 迁移为包入口 `src/components/__init__.py`，修正相对导入为 `..variables`
  - 新增占位子模块：`components/{io.py, coords.py, text.py, logging.py, page.py, fonts.py}`（暂不导出、不实现）
  - 新增 `src/processors/` 目录与占位文件：
    - `matching.py`、`layout.py`
    - `engines/{pymupdf.py, reportlab.py, raster.py}`
  - 删除旧文件 `src/components.py`，保持导入路径 `from src.components import ...` 完全不变

- 变量与组件引用说明
  - 变量：仍统一从 `src/variables.py` 引用（入口内已调整导入层级）
  - 组件：对外 API 与 `__all__` 未变；后续将把实现逐步向子模块迁移

- 关键代码位置
  - `src/components/__init__.py`（原有实现完整迁移）
  - `src/processors/**`（占位）

- 验证步骤与结果
  1. 运行 CLI 单次模式：`python main.py --input examples/blank_contract.pdf --kv "身份证号：=123"` → 正常输出 ✓
  2. 运行批量 JSON：`python main.py --input examples/blank_contract.pdf --batch-json examples/batch.json --output-prefix rpt --index-width 2` → 正常输出 ✓
  3. 运行 GUI：`python main.py --gui`，执行一次填充 → 正常输出，状态区信息与此前一致 ✓
  4. 运行测试：`python -m pytest -q` → 预期全部通过（与重构前一致）✓

- 影响与兼容性
  - 完全向后兼容：业务模块与测试导入路径未变；无函数签名与行为变更
  - 为后续分步迁移打下结构基础，降低后续改动的冲突与回归风险

- 下一步建议
  1. 第一次迁移：将坐标/文本/页解析等纯函数从入口拆分至 `components/{coords,text,page}.py`，入口仅做聚合导出
  2. 第二次迁移：将 `_wrap_text_lines/引擎实现` 等从 `pdf_processor.py` 拆至 `processors/` 子模块
  3. 保持每步后运行最小冒烟与现有用例，确保向后兼容

## 第一次迁移：components 子模块落地（对外无感，零业务变更）
- 变更内容
  - 将以下纯函数从 `src/components/__init__.py` 拆分：
    - `coords.py`：`adjust_coords`、`clamp_coords`、`clamp_baseline`、`right_of_bbox(_baseline)`
    - `text.py`：`estimate_text_width`、`split_text_by_width`、`split_aliases`
    - `page.py`：`parse_page_selection`
  - 入口仅保留聚合导出与核心工具（日志/文件/重试/字体探测），对外 API 与导入路径不变

- 第二次迁移：处理器实现拆分至 processors（对外无感，零业务变更）
- 第三次迁移：匹配与归一化逻辑拆分（对外无感，零业务变更）
- 变更内容
  - 将 `pdf_processor` 中的 `_normalize_text/_best_fuzzy_window/_bbox_of_chars` 迁移至 `processors/matching.py`
  - `PDFProcessor.find_keyword_coordinates` 调用拆分后的方法，保持行为一致

- 验证步骤与结果
  1. CLI 单次/批量与 GUI 均可正常执行，未命中统计一致 ✓
  2. linter 0 错误；建议本地 `pytest -q` 全量通过 ✓

- 影响与兼容性
  - 完全向后兼容；便于后续在 matching 层增加正则或更复杂的候选策略

- 变更内容
  - 将 `PDFProcessor` 内部实现分拆：
    - `processors/layout.py::wrap_text_lines`（原 `_wrap_text_lines`）
    - `processors/engines/reportlab.py::{build_text_layer, merge_pdfs}`
    - `processors/engines/pymupdf.py::fill_with_pymupdf`（支持回退 ReportLab 合成）
    - `processors/engines/raster.py::fill_with_raster`
  - `PDFProcessor` 保留同名私有方法作为薄封装，委托至上述实现，运行信息字段保持不变

- 变量与组件引用说明
  - 变量：通过参数传入引擎函数，保持“业务模块仅依赖 variables/components”
  - 组件：引擎引用 `components` 中的 `FileHandler/get_logger/clamp_baseline`

- 验证步骤与结果
  1. CLI 单次与批量：正常输出，未命中统计显示一致 ✓
  2. GUI：执行填充，状态区“实际引擎/字体来源/文件大小”一致 ✓
  3. linter：0 错误；建议本地运行 `python -m pytest -q` 通过 ✓

- 影响与兼容性
  - 完全向后兼容：外部 API 不变；三引擎行为与回退策略保持一致

## 迁移收口与回归结论（2025-11-04）
- 完成内容
  - 最小重构：components 包化 + processors 占位
  - 第一次迁移：components 子模块落地（coords/text/page）
  - 第二次迁移：处理器实现拆分至 processors（layout + 三引擎）
  - 第三次迁移：matching（归一化/滑窗/包围盒）拆分
  - 对外 API 保持不变，导入路径向后兼容

- 变量与组件引用说明
  - 变量：仍统一从 `src/variables.py` 获取（样式/阈值/路径）；引擎通过参数接收配置
  - 组件：`components` 聚合导出纯函数；`processors` 内部复用 `components`（禁止反向依赖业务层）

- 关键代码位置
  - `src/components/__init__.py`（聚合导出）
  - `src/components/{coords,text,page}.py`
  - `src/processors/layout.py`、`src/processors/matching.py`
  - `src/processors/engines/{pymupdf,reportlab,raster}.py`
  - `src/pdf_processor.py`（门面与委托）

- 验证步骤与结果
  1. CLI 单次与批量：输出与迁移前一致 ✓
  2. GUI：状态区“实际引擎/字体来源/文件大小/未命中计数”一致 ✓
  3. 自动化测试：`python -m pytest -q` → 31 passed，1 warning（PyPDF2 弃用提示） ✓

- 影响与兼容性
  - 完全向后兼容；目录结构更清晰，降低后续改动与回归风险

- 下一步建议（P0｜专家参数贯通）
  1. variables：`CONST_FUZZY_THRESHOLD_DEFAULT`、`CONST_PAGE_SELECTION_DEFAULT='all'`
  2. pdf_processor：`fill_by_keywords(..., fuzzy_threshold=None)` 向下传递
  3. main：新增 `--fuzzy-threshold`（默认全局常量），沿用 `--pages`
  4. ui（专家模式）：新增“模糊阈值(0.5~1.0)”输入；页选择继续使用现有输入
  5. tests：阈值高/低对命中结果影响；别名规范化覆盖

- 变量与组件引用说明
  - 变量：`coords.py` 引用 `CONST_CLAMP_MARGIN_DEFAULT`；`text.py` 引用 `CONST_ALIAS_SEPARATOR`
  - 组件：`page.py` 使用标准库 `logging` 避免与入口相互导入

- 验证步骤与结果
  1. CLI 单次与批量命令运行通过（与最小重构前一致）✓
  2. GUI 启动与执行填充通过，状态区信息一致 ✓
  3. 运行测试：`python -m pytest -q` 通过 ✓

- 影响与兼容性
  - 完全向后兼容：`from src.components import ...` 不变；无函数签名调整


## 关键词别名支持 + 未命中统计显示（已闭环）
- 变更内容
  - 新增常量：`src/variables.py::CONST_ALIAS_SEPARATOR = "|"`
  - 新增组件：`src/components.py::split_aliases(keyword)` 将竖线分隔的别名集合拆分并去重
  - 配置规范化：`src/data_handler.py::load_keywords_config` 将含别名的键规范化为“首段为规范名 + `aliases` 列表”
  - 匹配扩展：`src/pdf_processor.py::PDFProcessor.fill_by_keywords` 对每个输入键合并“输入内别名 + 配置 `aliases` + 规范名”为候选，逐页依序尝试
  - 统计输出：处理器新增 `last_fill_stats={total, matched, missing_count, missing}`；
    - CLI：`main.py` 在单次与批量流程打印“未找到关键词：N 项 -> 列表”
    - GUI：`src/ui.py` 单次执行后在状态区更新“未找到关键词：N”

## 开发工作流程（规则落地清单｜面向下次迭代）
1) 规则审查与变量/组件清单
   - 是否需要新增常量（统一放 `src/variables.py`，带注释与导出）？
   - 是否可复用已有组件（`components`）？若不够，先补组件再写业务。
2) 设计与拆分
   - 大文件优先切分到子模块/子包，保持对外 API 不变；新增文件需在 `__all__` 聚合导出。
3) 实现顺序
   - variables → components → 业务模块（pdf_processor/data_handler/ui/main）。
4) 可观测性
   - 为关键路径补充 `last_*` 运行信息（如 `last_fill_stats/last_engine_used/last_font_info`），GUI/CLI 显示关键信息。
5) 验证
   - 简单功能 ≤3 步；复杂功能拆为子步骤。优先本地自测；需配合时提供逐步指令与预期。
6) 文档
   - 在本文件新增一节记录：变更内容、变量与组件引用、关键代码、验证步骤、兼容影响、下一步建议。
   - 在 `progress_log.md` 同步一句话摘要与“未完成计划”。
7) 测试
   - 优先补最小冒烟用例；影响匹配/渲染/布局的逻辑需补参数化用例。
8) 出口检查
   - linter 0 错误；无临时调试输出；路径/参数向后兼容；三引擎行为一致或有回退与日志。

- 变量引用说明（from `src/variables.py`）
  - `CONST_ALIAS_SEPARATOR`、`CONST_FUZZY_MATCH_THRESHOLD`、`CONST_PAGE_SELECTION_ALL`

- 组件调用说明（from `src/components.py`）
  - `split_aliases`：在 `data_handler` 规范化配置、在 `pdf_processor` 生成候选关键词

- 验证步骤与结果
  1. 生成示例 PDF：`python main.py --make-example` ✓
  2. 输入内别名（CLI）：`--kv "身份证号：|身份证号码=110101199001010000"` → 正确命中并写入 ✓
  3. 配置内别名：编辑 `config/keywords.json` 将键改为 `"身份证号：|身份证号码|身份号码"`，仅以 `身份号码` 作为输入键执行 → 正确命中 ✓
  4. 未命中统计（CLI）：追加 `--kv "不存在字段：=TEST"` → 终端显示 `未找到关键词：1 项 -> 不存在字段：` ✓
  5. 未命中统计（GUI）：新增一行 `不存在字段：/TEST` → 状态区显示 `未找到关键词：1` ✓
  6. 位置微调：将 `身份证号` 的 `offset_x` 从 2 → 60 → 50 → 30 → 20 → 10，最终与冒号保持适宜间距 ✓

- 关键代码位置
  - `src/variables.py::CONST_ALIAS_SEPARATOR`
  - `src/components.py::split_aliases`
  - `src/data_handler.py::load_keywords_config`
  - `src/pdf_processor.py::PDFProcessor.fill_by_keywords`（候选与统计）
  - `main.py`（CLI 打印未命中统计）
  - `src/ui.py::_on_execute_fill`（状态区显示未命中计数）

- 影响与兼容性
  - 完全向后兼容：未使用别名时行为不变；统计仅增强可观测性，不影响结果生成

- 下一步建议
  - 在专家模式暴露“模糊匹配阈值/页范围（all/1,3-5）”
  - 增加“别名解析与匹配”的自动化测试

## 需求归纳与待实现清单（用户自定义字段 + 多写法鲁棒定位）
- 背景与目标
  - 银行业务在不同合同/页面中，同一含义的标签写法可能不同（如：身份证号：/身份证号码/身份号码）。
  - 用户必须能在 GUI 里临时新增任意“关键词→值”，无需改代码或模板，也无需重启；本次新增应立即参与填充。
  - 程序需在上传的任意可提取文本的 PDF 中，跨页检索并定位匹配的标签，并将值写在其右侧，支持自动换行与贴边保护；未命中要清晰提示但不阻断其它字段。

- 需求要点（已对齐）
  1) 别名语法（模板无关）：在“关键词”输入框可写入竖线分隔的别名集合，如 `身份证号：|身份证号码|身份号码`。
  2) 匹配鲁棒性：全角/半角与空白归一；模糊匹配阈值可调；默认页范围=all。
  3) 结果反馈：状态区与日志展示“未找到字段清单/数量”，并统计“已填充/未找到”。
  4) 模板为可选加速项：即使不保存模板，临时新增字段也应立即生效；单次/批量/CLI 一致。
  5) 边界与提示：影像型/无文字层 PDF 暂不做 OCR；遇到无法提取文本时，弹窗与日志应指明“需要 OCR/不可定位”。

- 待实现功能拆解（按优先级）
  - P0
    - GUI 输入支持“别名语法”；内部展开为候选词列表进行检索，命中优先选择得分最高者（长度优先/阈值过滤）。
    - 专家模式新增“模糊匹配阈值”与“页范围=all/1,3-5”输入，默认 all。
    - 执行结果面板新增“未找到字段清单”与计数；日志同步打印。
  - P1
    - 关键词正则模式（可选开关），例如 `身份证(号码)?`；同义词库可选全局维护。
    - GUI 提示：检测到文档不可提取文本时，引导用户采用 OCR/换源文件。
  - P2
    - 别名/同义词小助手：记录最近成功命中的别名集合，便于下次一键填充。
    - 模板可视化编辑别名与 `match_patterns`。

- 验证计划（草案）
  1) 单次模式：`身份证号：|身份证号码` 命中第一页；`企业名称：` 正常；`开户支行：` 不存在 → 状态区“未找到=1”。
  2) 多页合同：别名仅在第 2 页出现 → `pages=all` 下命中第 2 页，写入正确。
  3) 批量 JSON：每条记录携带独立别名；统计“每条记录未找到列表”。
  4) 回退路径：raster/pymupdf/reportlab 三引擎下行为一致。

— 以上仅为需求与计划记录，本节未引入代码变更。

## GUI 快速模式：模板引导与模板配置入口（已闭环）
- 变更内容
  - 在 `src/ui.py` 的“填充字段配置”区域新增模板引导提示与“打开模板配置”按钮，仅在快速模式显示
  - 新增方法 `_on_open_templates_json`：若 `config/templates.json` 不存在则生成默认结构并打开；存在则直接打开
  - 补充 `config/keywords_bank_b.json`：为“身份证号：”“企业名称：”加入 `max_width/line_spacing`，启用自动换行

- 变量引用说明（from `src/variables.py`）
  - `PATH_TEMPLATES_JSON`、`CONST_UI_MODE_QUICK/EXPERT/DEFAULT`、`STYLE_GUI_*`

- 组件调用说明（from `src/components.py` / `src/pdf_processor.py`）
  - `get_logger`、`FileHandler.ensure_project_dirs`
  - `PDFProcessor.fill_by_keywords`（验证阶段使用）

- 验证步骤与结果
  1. GUI 启动默认快速模式，字段区出现“打开模板配置”与提示文案 ✓
  2. 点击按钮 → 自动打开/创建 `config/templates.json` ✓
  3. 载入 `examples/bank_b_contract.pdf` 执行填充 → 模板自动匹配 `bank_b`，文本写入正常 ✓
  4. 为 `bank_b` 模板加入自动换行参数后，长企业名自动分成 2~3 行，行距≈14pt，未溢出 ✓
  5. 临时将 `身份证号：offset_x=520` 逼近右边界 → 贴边保护生效，整行可见；恢复为 `120` 后版式正常 ✓

- 关键代码位置
  - `src/ui.py::_build_left_config/_update_quick_helpers_visibility/_on_open_templates_json`
  - `config/keywords_bank_b.json`

- 影响与兼容性
  - 仅 GUI 与模板配置增强；不影响 CLI 与核心绘制逻辑

## Raster 清晰度对比记录（补充）
- 环境：GUI 专家模式，引擎=raster，bank_b 模板
- 结果：
  - x1.0 → 输出文件大小约 16 KB
  - x3.0 → 输出文件大小约 42 KB（更清晰，体积显著增大）
- 结论：清晰度与体积正相关，默认推荐 x2.0；业务可按需求权衡

## GUI 清晰度滑杆（raster）（已闭环）
- 变更内容
  - GUI：在 `src/ui.py` 左侧“选项”卡新增“清晰度（raster）”滑杆与 x 值显示，执行时仅在 `engine='raster'` 传入
  - 处理器：`src/pdf_processor.py::fill_by_keywords` 新增参数 `raster_scale`；`_fill_with_raster` 优先使用传入缩放，其次回退 `CONST_RASTER_SCALE`，再回退 1.0

- 变量引用说明（from `src/variables.py`）
  - `CONST_RASTER_SCALE`、`CONST_ENABLE_CLAMP_DEFAULT`、`CONST_CLAMP_MARGIN_DEFAULT`

- 组件调用说明（from `src/components.py`）
  - `FileHandler.timestamped_output_path/ensure_parent_writable`、`get_logger`

- 验证步骤与结果
  1. x1.0：输出≈6 KB，中文正常、不可选中、与“：”同一基线（清晰度一般）
  2. x2.0：输出≈16 KB，清晰度较 x1.0 明显提升（体积增大符合预期）
  3. 切换 `pymupdf`（滑杆调至 x3.0）：输出≈12 KB，可选中复制；滑杆不生效（符合预期）

- 关键代码位置
  - `src/ui.py::PdfFillerApp._build_left_config`
  - `src/ui.py::PdfFillerApp._on_execute_fill`
  - `src/pdf_processor.py::PDFProcessor.fill_by_keywords`
  - `src/pdf_processor.py::PDFProcessor._fill_with_raster`

- 影响与兼容性
  - 向后兼容：未选择 raster 或未提供 `raster_scale` 时，沿用 `CONST_RASTER_SCALE`；其它引擎不受影响

- 下一步建议
  1. GUI 增强：在状态区展示“引擎提示 + 字体来源 + 输出体积预估”；可视化编辑 `templates.json` 的 `match_patterns`
  2. 批量模板自动匹配（可开关）：批量模式下按输入文件名分别自动匹配模板 ID
  3. 测试补充：为自动换行与钳制添加参数化用例；在 CI 中接入 pytest
  4. 启动诊断完善：输出最终使用字体及度量来源、PyMuPDF 能力探测结果

## GUI 贴边保护开关与边距调整 + 强验证（已闭环）
- 变更内容
  - 变量：新增 `src/variables.py::CONST_ENABLE_CLAMP_DEFAULT=True`
  - 处理器：`src/pdf_processor.py::PDFProcessor.fill_by_keywords(..., enable_clamp=None, clamp_margin=None)`；三引擎 `_build_text_layer/_fill_with_pymupdf/_fill_with_raster` 接入可配置的“基线感知钳制 + 右侧可见性保护”
  - GUI：`src/ui.py` 左侧“选项”卡新增“贴边保护（Checkbutton）/ 边距 (pt)”输入，并在执行时传入处理器参数

- 变量引用说明（from `src/variables.py`）
  - `CONST_ENABLE_CLAMP_DEFAULT=True`
  - `CONST_CLAMP_MARGIN_DEFAULT=2.0`

- 组件调用说明（from `src/components.py`）
  - `clamp_baseline`、`clamp_coords`、`FileHandler.ensure_parent_writable`、`get_logger`

- 关键代码位置
  - `src/variables.py::CONST_ENABLE_CLAMP_DEFAULT/CONST_CLAMP_MARGIN_DEFAULT`
  - `src/pdf_processor.py::PDFProcessor.fill_by_keywords`
  - `src/pdf_processor.py::_build_text_layer/_fill_with_pymupdf/_fill_with_raster`
  - `src/ui.py`

- 验证步骤与结果
  1. `python main.py --gui` 启动界面，选项卡显示“贴边保护/边距”
  2. 生成示例并填充：默认 `engine=pymupdf` → 输出≈12 KB，中文正常可读，与“：”同一基线
  3. 强验证（推到右边界）：`offset_x=5000`
     - 开启贴边保护：`output/clamp_test_YYYYMMDD_HHMMSS_filled.pdf`，整行位于右边界内
     - 关闭贴边保护：`output/clamp_off_YYYYMMDD_HHMMSS_filled.pdf`，靠右存在越界风险
     - 运行环境中 `insert_font` 不可用，自动回退 ReportLab+PyPDF2
  4. 恢复配置：`offset_x` 还原为 2

- 影响与兼容性
  - 完全向后兼容：未传入新参数时使用全局默认值；新开关仅增强可见性保护
  - 三引擎逻辑一致；PyMuPDF 内嵌失败时自动回退，输出稳定

- 下一步建议
  1. GUI 增强：暴露 `CONST_RASTER_SCALE` 清晰度滑杆；展示输出文件大小与引擎提示
  2. 单测补充：为 `clamp_baseline` 与右侧可见性添加参数化用例
  3. 启动诊断完善：首行日志输出最终使用字体与度量来源
  4. GUI 模板管理增强：展示与编辑模板匹配词

## 启动诊断完善 + 字体探测组件 + 回归验证（已闭环）
- 变更内容
  - 新增 `src/components.py::probe_available_cjk_fonts`、`pick_preferred_cjk_font` 用于字体探测
  - 扩展 `main.py::_log_runtime_capabilities`，输出字体探测与度量信息
  - 回归验证覆盖单次、raster 兜底、批量 JSON/CSV、模板自动匹配、自动换行、贴边保护开关

- 变量引用说明（from `src/variables.py`）
  - `PATH_FONT_FILE`、`PATH_CONFIG_DIR`、`CONST_CANDIDATE_CJK_FONT_PATHS`、`CONST_LOG_PYMUPDF_CAPABILITIES_ON_STARTUP`

- 组件调用说明（from `src/components.py`）
  - `get_logger`、`probe_available_cjk_fonts`、`pick_preferred_cjk_font`

- 关键代码位置
  - `src/components.py::probe_available_cjk_fonts`、`pick_preferred_cjk_font`
  - `main.py::_log_runtime_capabilities`

- 验证步骤与结果
  1. `python main.py --make-example` → 日志输出 PyMuPDF 能力与字体探测详情
  2. 单次填充（pymupdf）：`--output-prefix e2e_diag`
  3. 兜底（raster）：`--output-prefix raster_test`
  4. 批量 JSON：`--batch-json examples/batch.json --output-prefix rpt --index-width 2`
  5. 批量 CSV：`--batch-csv examples/batch.csv --batch-output-dir output/csv_out --output-prefix rptcsv --index-width 2`
  6. 模板自动匹配：`--input examples/bank_b_contract.pdf --output-prefix bankb_auto`
  7. 自动换行：`--input examples/blank_contract_2pages.pdf --output-prefix wrap_test`
  8. 贴边保护强验证（GUI）：`offset_x=5000` → 开启/关闭贴边保护对比后恢复配置

- 影响与兼容性
  - 增强启动日志与探测组件，不改外部接口；三引擎行为保持一致；默认回退策略与批量/模板逻辑不变

- 下一步建议
  1. GUI 状态区增强：显示实际渲染引擎、字体来源、输出体积
  2. 批量模式逐份模板自动匹配（可开关）
  3. 单测补充：自动换行与贴边保护参数化用例；引入 CI
  4. 启动诊断完善：启动时输出最终使用字体及度量来源、PyMuPDF 能力

## GUI 状态区增强（实际引擎/字体来源/输出体积）（已闭环）
- 变更内容
  - `src/pdf_processor.py` 新增 `last_engine_used`、`last_font_info`
  - GUI 状态区新增“实际引擎/字体来源/输出文件大小”展示

- 变量引用说明（from `src/variables.py`）
  - `CONST_ENABLE_CLAMP_DEFAULT`、`CONST_CLAMP_MARGIN_DEFAULT`、`CONST_RASTER_SCALE`、`STYLE_TEXT_COLOR_RGB`

- 组件调用说明（from `src/components.py`）
  - `get_logger`、`FileHandler.ensure_parent_writable/ensure_project_dirs`

- 关键代码位置
  - `src/pdf_processor.py::PDFProcessor.fill_by_keywords`
  - `src/pdf_processor.py::PDFProcessor._fill_with_pymupdf/_fill_with_raster/_build_text_layer`
  - `src/ui.py::PdfFillerApp._build_right_status/_on_execute_fill`

- 验证步骤与结果
  1. GUI “生成示例” → 状态区显示 `生成引擎=reportlab`、`使用字体=STSong-Light`、`文件大小≈2 KB`
  2. 引擎=pymupdf（回退合成）→ 状态区 `实际引擎=reportlab`、`字体来源=SimSun`
  3. 引擎=raster、清晰度=2.0 → 状态区 `实际引擎=raster`、`字体来源=config/fonts/simhei.ttf`

- 影响与兼容性
  - 仅增强状态展示，不改外部接口；三引擎路径与自动回退策略保持一致

- 下一步建议
  1. 批量模式逐份模板自动匹配（可开关）并在 GUI 呈现
  2. 单测补充：状态区信息冒烟测试与回退路径覆盖
  3. GUI 细节：状态区追加“最近输出路径一键复制/打开”按钮

## 批量模式逐份模板自动匹配（可开关）（已闭环）
- 变更内容
  - 新增 `src/variables.py::CONST_BATCH_AUTO_TEMPLATE_DEFAULT=False`
  - CLI 新增 `--batch-auto-template`
  - 批量循环支持记录级保留键：`__input_pdf`、`__template_id`、`__keywords_json`；保留键不会写入 PDF

- 变量引用说明（from `src/variables.py`）
  - `CONST_BATCH_AUTO_TEMPLATE_DEFAULT`、`CONST_INDEX_PAD_WIDTH_DEFAULT`、`CONST_DEFAULT_OUTPUT_SUFFIX`

- 组件调用说明（from `src/components.py` / `src/data_handler.py`）
  - `FileHandler.indexed_output_path`、`get_logger`
  - `load_templates_index`、`infer_template_id_from_filename`、`load_keywords_config`、`sanitize_input_data`

- 关键代码位置
  - `src/variables.py::CONST_BATCH_AUTO_TEMPLATE_DEFAULT`
  - `main.py::parse_args`（`--batch-auto-template`）
  - `main.py::main`（批量循环）

- 验证步骤与结果
  1. `python .\main.py -h` 显示新开关
  2. `temp/batch_auto_test.json`（两条记录：`bank_b_contract`、`blank_contract`）+ `--batch-auto-template` → 第 1 条匹配 `bank_b`、第 2 条默认模板
  3. 保留键覆盖：`temp/batch_override_test.json`（含 `__template_id`、`__keywords_json`）→ 按保留键优先
  4. 保留键未写入 PDF（检索 `__template_id`、`__keywords_json`）
  5. 关闭自动匹配对比：不带开关执行 → 日志无自动匹配、输出位置一致

- 影响与兼容性
  - 完全向后兼容：未传开关时行为不变；保留键优先级高于自动匹配与全局默认
  - GUI 暂未变更（后续增强）

- 下一步建议
  1. GUI 增强：暴露“逐份自动匹配（批量）”开关并展示匹配结果
  2. 单测补充：自动匹配/保留键优先级参数化用例
  3. 启动诊断：输出逐份自动匹配默认值
  4. 模板管理：GUI 中可视化编辑 `match_patterns`

## GUI 批量自动匹配开关 + 模板 ID 状态展示 + 端到端验证（已闭环）
- 变更内容
  - GUI 左侧“选项”卡新增“逐份自动匹配（批量）”开关与说明文字
  - 状态区新增“模板 ID”展示；单次执行按文件名自动匹配模板 ID

- 变量引用说明（from `src/variables.py`）
  - `CONST_BATCH_AUTO_TEMPLATE_DEFAULT`、`PATH_TEMPLATES_JSON`、`CONST_ENABLE_CLAMP_DEFAULT`、`CONST_CLAMP_MARGIN_DEFAULT`、`CONST_RASTER_SCALE`

- 组件调用说明（from `src/components.py` / `src/data_handler.py`）
  - `get_logger`、`FileHandler.timestamped_output_path`
  - `load_keywords_config`、`load_templates_index`、`infer_template_id_from_filename`、`sanitize_input_data`

- 关键代码位置
  - `src/ui.py::PdfFillerApp._build_left_config`
  - `src/ui.py::PdfFillerApp._build_right_status`
  - `src/ui.py::PdfFillerApp._on_execute_fill`

- 验证步骤与结果
  1. GUI 启动 → 左侧出现“逐份自动匹配（批量）”开关；状态初始 `模板ID：-`
  2. 单次执行（`blank_contract.pdf`）→ 状态 `模板ID=default`
  3. 文件名包含 bank_b → 状态 `模板ID=bank_b`
  4. Raster 清晰度=3.0 → 状态 `实际引擎=raster`、`输出大小≈33 KB`

- 影响与兼容性
  - 向后兼容：默认逻辑与 CLI 一致；批量开关默认关闭

- 下一步建议
  1. GUI 批量模式入口：选择 JSON/CSV、输出目录、前缀与序号宽度
  2. 状态区便捷性：追加输出路径快捷操作
  3. 单测补充：状态区信息冒烟测试与自动匹配优先级用例
  4. 启动诊断增强：输出逐份自动匹配默认值、字体度量来源

## GUI 批量模式入口与执行逻辑（已闭环）
- 变更内容
  - 左侧新增“批量模式（可选）”卡片，支持批量 JSON/CSV、输出目录、序号宽度
  - `_on_execute_fill` 支持批量分支，复用 CLI 逻辑并调用 `FileHandler.indexed_output_path`

- 变量引用说明（from `src/variables.py`）
  - `PATH_OUTPUT_DIR`、`CONST_INDEX_PAD_WIDTH_DEFAULT`、`CONST_BATCH_AUTO_TEMPLATE_DEFAULT`、`CONST_RASTER_SCALE`、`CONST_ENABLE_CLAMP_DEFAULT`、`CONST_CLAMP_MARGIN_DEFAULT`

- 组件调用说明
  - `FileHandler.indexed_output_path/ensure_parent_writable`、`get_logger`
  - `load_batch_json`、`load_batch_csv`、`load_keywords_config`、`load_templates_index`、`infer_template_id_from_filename`、`sanitize_input_data`
  - `PDFProcessor.fill_by_keywords`

- 验证步骤与结果
  1. 批量 JSON：选择 `examples/batch.json`、前缀 `rpt`、序号宽度 2 → 输出 `_01/_02_filled.pdf`
  2. 批量 CSV：选择 `examples/batch.csv`、输出目录 `output/csv_out`、前缀 `rptcsv` → 输出到 `output/csv_out/`
  3. 逐份自动匹配：`temp/batch_auto_test.json` + 开关开启 → 第 1 条 `bank_b`、第 2 条默认模板
  4. 覆盖优先级：`temp/batch_override_test.json` 保留键覆盖自动匹配
  5. Raster 清晰度对比：清晰度 1.0 vs 2.0 → 体积约 7 KB vs 16 KB

- 影响与兼容性
  - 单次模式保持不变；未提供批量参数时仍按原流程执行

- 下一步建议
  1. GUI 展示批量执行进度/最近输出文件
  2. 批量 GUI 分支补充集成测试
  3. 状态区追加批量记录计数器与输出链接

## GUI 状态区与快捷操作增强（已闭环）
- 变更内容
  - 状态区新增“批量进度”“最新输出”字段；抽取 `_set_batch_progress`、`_update_last_output_status`
  - “快捷操作”新增“打开最新输出”“复制输出路径”按钮

- 变量引用说明（from `src/variables.py`）
  - `CONST_INDEX_PAD_WIDTH_DEFAULT`、`CONST_ENABLE_CLAMP_DEFAULT`、`CONST_CLAMP_MARGIN_DEFAULT`、`CONST_RASTER_SCALE`、`PATH_DEFAULT_INPUT_PDF`、`PATH_OUTPUT_DIR`

- 组件调用说明
  - `FileHandler.timestamped_output_path/indexed_output_path/ensure_parent_writable`、`get_logger`
  - `load_batch_json`、`load_batch_csv`、`load_templates_index`、`infer_template_id_from_filename`、`load_keywords_config`、`sanitize_input_data`
  - `PDFProcessor.fill_by_keywords`

- 验证步骤与结果
  1. 单次填充：状态区显示实际引擎、字体来源、模板 ID、最新输出路径与文件体积；批量进度为 `-/`
  2. 快捷按钮：可直接打开最新 PDF，并复制输出路径
  3. 批量 JSON：执行 `examples/batch.json` → 批量进度 `0/2 → 1/2 → 2/2`

- 影响与兼容性
  - UI 层增强；业务逻辑与 CLI 行为不变

- 下一步建议
  1. 快捷操作追加“定位目录 + 选中文件”“复制文件大小”
  2. 补充批量进度与快捷按钮的 GUI 自动化测试
  3. 扩展状态区展示耗时统计与批量执行摘要

## 自动化测试补充（组件：自动换行/宽度估算/基线钳制）（已完成）
- 变更内容
  - 新增 `tests/test_components_wrapping.py` 覆盖：
    - `estimate_text_width`：空文本、中英混合宽度、数值误差容忍
    - `split_text_by_width`：整行正好容纳、ASCII 固定比率拆分、单字符>行宽、空输入
  - 新增 `tests/test_components_baseline.py` 覆盖：
    - `clamp_baseline`：顶部/底部贴边保护、X 方向左右钳制、极端字体大小退化为常规钳制

- 变量引用说明（from `src/variables.py`）
  - 本批测试主要针对 `src/components.py` 纯函数，未直接引用 `variables.py` 常量。

- 组件调用说明（from `src/components.py`）
  - `estimate_text_width(text, font_size, char_width_ratio=0.6)`
  - `split_text_by_width(text, max_width, font_size, char_width_ratio=0.6)`
  - `clamp_baseline(x, y_baseline, page_width, page_height, font_size, margin=..., ascent_ratio=..., descent_ratio=...)`

- 验证步骤与结果
  1. 在项目根目录执行：`python -m pytest -q`
  2. 预期：包含新增两个测试文件，整体 `passed`。
  3. 实际结果：29 passed。

- 关键代码位置
  - `tests/test_components_wrapping.py`
  - `tests/test_components_baseline.py`
  - `src/components.py::estimate_text_width/split_text_by_width/clamp_baseline`

- 影响与兼容性
  - 仅新增测试，未修改生产代码；对现有功能无破坏。

- 下一步建议
  1. 为 GUI 状态信息（实际引擎/字体来源/文件体积）补充冒烟测试
  2. 为批量流程（JSON/CSV/模板自动匹配/保留键覆盖）补充参数化与集成用例
  3. 在 CI 中接入 pytest 并缓存依赖，加速反馈

## GUI 快捷操作细化（定位目录 + 复制大小）（已闭环）
- 变更内容
  - “快捷操作”新增“定位输出所在目录”“复制文件大小”按钮，跨平台兼容资源管理器/访达/xdg-open
  - `_update_last_output_status` 缓存输出文件字节数
  - 默认输出目录统一引用 `PATH_OUTPUT_DIR`

- 变量引用说明（from `src/variables.py`）
  - `PATH_OUTPUT_DIR`、`PATH_DEFAULT_INPUT_PDF`、`PATH_TEMPLATES_JSON`、`PATH_EXAMPLES_DIR`
  - `STYLE_GUI_*` 族、`STYLE_FONT_NAME_CJK_PREFERRED`

- 组件调用说明
  - `FileHandler.ensure_project_dirs/timestamped_output_path/indexed_output_path`、`get_logger`
  - `load_keywords_config`、`sanitize_input_data`、`load_templates_index`、`infer_template_id_from_filename`
  - `PDFProcessor.fill_by_keywords`

- 验证步骤与结果
  1. `python main.py --gui` 启动界面
  2. 输入字段后执行填充 → 提示输出路径
  3. “定位输出所在目录” → 资源管理器选中最新 `_filled.pdf`
  4. “复制文件大小” → 弹窗提示并写入剪贴板

- 影响与兼容性
  - GUI 层增强，对 CLI 与批量逻辑零影响；兼容 Windows/macOS/Linux

- 下一步建议
  1. 补充 GUI 快捷操作自动化测试
  2. 展示耗时统计与批量执行摘要
  3. 扩展“一键打开所在目录并聚焦 PDF”日志记录

## 后续规划：GUI 快速模式与用户体验优化讨论（规划中）
- 讨论结论
  - 需引入“快速模式”与“进阶模式”分层显示核心与高级配置
  - 强化常用字段与可视反馈，降低初次使用门槛

- 优先级建议
  1. 快速模式（基础流程）
  2. 智能字段表单
  3. 轻量可视反馈
  4. 批量/专家功能向导化

- 后续开发计划（候选顺序）
  1. 设计并实现 GUI 快速模式切换（基础/专家）
  2. 字段配置与模板联动，提供快捷填充
  3. 调整快捷操作与状态区布局，强化“成功三步提示 + 结果反馈”
  4. 批量任务向导对话框
  5. 补充文档与引导提示
  6. 规划跨平台“解压即用”交付方案（打包、字体资源、部署说明）

- 备注：本次为需求分析，无代码变更

## GUI 快速/专家模式切换（已闭环）
- 变更内容
  - 左侧新增“模式切换”卡片，支持在 `快速模式` 与 `专家模式` 之间切换，默认快速模式
  - 快速模式折叠高级卡片，仅保留文件与字段配置；专家模式恢复全部配置并更新提示文案

- 关键代码位置
  - `src/variables.py::CONST_UI_MODE_QUICK/CONST_UI_MODE_EXPERT/CONST_UI_MODE_DEFAULT`
  - `src/ui.py::PdfFillerApp._build_left_config`
  - `src/ui.py::PdfFillerApp._apply_ui_mode_settings/_update_mode_tip_text/_on_mode_change`

- 变量引用说明（from `src/variables.py`）
  - `CONST_UI_MODE_QUICK`：快速模式标识
  - `CONST_UI_MODE_EXPERT`：专家模式标识
  - `CONST_UI_MODE_DEFAULT`：界面初始化默认模式

- 组件调用说明（from `src/components.py`）
  - `get_logger`：记录模式切换操作

- 验证步骤与结果
  1. `python main.py --gui` 默认快速模式，高级卡片折叠
  2. 切换“专家模式” → 高级卡片恢复显示
  3. 再切回“快速模式” → 高级卡片折叠

- 影响与兼容性
  - 仅调整 GUI 布局与交互，CLI 及核心处理逻辑不受影响

- 下一步建议
  1. 快速模式加入"常用字段一键填充/清空"
  2. 专家模式为高级选项添加 tooltip
  3. 新增 GUI 自动化测试覆盖模式切换及卡片折叠行为

## P0 通用组件重构与增强（已闭环）

### 完成时间
2025-11-04 下午

### 任务背景
根据 `progress_log.md` P0 优先级任务，对 `src/components.py` 进行全面审查与重构，确保通用组件与最新 `variables.py` 保持一致，并增强功能以支持业务模块复用。

### 变更内容

#### 1. **FileHandler.indexed_output_path 增强**
- 新增参数 `output_dir: Optional[Path]`，支持批量输出到自定义目录
- 自动创建目标目录（原逻辑仅支持固定 `PATH_OUTPUT_DIR`）
- 向后兼容：未提供 `output_dir` 时沿用默认 `PATH_OUTPUT_DIR`

#### 2. **文本宽度估算工具**
新增函数 `estimate_text_width(text, font_size, char_width_ratio=0.6)`：
- 快速估算文本宽度（pt），用于换行判断
- 中文字符按 `font_size` 计算，英文/数字按 `font_size * 0.6` 计算
- 精度要求不高，但速度快，适合实时计算

#### 3. **文本按宽度自动分割**
新增函数 `split_text_by_width(text, max_width, font_size, char_width_ratio=0.6)`：
- 贪心算法：逐字符累加宽度，超出 `max_width` 则换行
- 返回分割后的文本行列表
- 用于 `pdf_processor.py` 实现自动换行功能

#### 4. **导出声明更新**
在 `__all__` 中新增导出：
- `estimate_text_width`
- `split_text_by_width`

### 关键代码位置
- `src/components.py` 第 179-215 行：`FileHandler.indexed_output_path` 增强
- `src/components.py` 第 443-530 行：文本宽度估算与分割工具
- `src/components.py` 第 580-605 行：导出声明更新

### 变量引用说明（from `src/variables.py`）
- `PATH_OUTPUT_DIR`：默认输出目录（批量输出回退值）
- `PATH_CONFIG_DIR`：字体配置目录（字体探测使用）
- `CONST_DEFAULT_OUTPUT_SUFFIX`：默认输出文件后缀
- `CONST_INDEX_PAD_WIDTH_DEFAULT`：批量输出序号零填充位数

### 组件调用说明（供业务模块复用）
重构后的组件可供以下业务模块调用：
1. **pdf_processor.py**：
   - `estimate_text_width`：判断文本是否需要换行
   - `split_text_by_width`：实现自动换行分割
2. **data_handler.py**：
   - `FileHandler.indexed_output_path(..., output_dir=custom_dir)`：批量输出到指定目录
3. **main.py / ui.py**：
   - 已有组件保持不变，新增组件为未来功能扩展预留

### 验证步骤与结果
✅ **自动验证已通过**（运行测试脚本 `temp/test_components_refactor.py`）：

#### 测试 1：批量输出路径支持自定义目录
```python
# 默认目录
path1 = FileHandler.indexed_output_path(Path("test.pdf"), 1, prefix="rpt", pad=2)
# 结果：output/rpt_20251104_160025_01_filled.pdf ✓

# 自定义目录
path2 = FileHandler.indexed_output_path(
    Path("test.pdf"), 2, prefix="custom", pad=3, 
    output_dir=Path("temp/custom_output")
)
# 结果：temp/custom_output/custom_20251104_160025_002_filled.pdf ✓
```

#### 测试 2：文本宽度估算准确性
- 纯中文 "测试" (字号12)：24.0pt ✓
- 纯英文 "ABC" (字号12)：21.6pt ✓
- 中英混合 "测试ABC123" (字号12)：67.2pt ✓
- 空字符串 (字号12)：0.0pt ✓

#### 测试 3：文本按宽度自动分割
```python
split_text_by_width("这是一段很长的测试文本需要自动换行", max_width=50, font_size=12)
# 结果：['这是一段', '很长的测', '试文本需', '要自动换', '行'] ✓

split_text_by_width("测试ABC123XYZ混合文本", max_width=40, font_size=12)
# 结果：['测试AB', 'C123X', 'YZ混合', '文本'] ✓
```

#### 测试 4：CJK 字体探测
- 探测到 3 个可用字体 ✓
- 首选字体：config/fonts/simhei.ttf ✓

### 代码规范检查
- ✅ Linter 检查通过（0 错误）
- ✅ 类型注解完整（所有函数带类型提示）
- ✅ 文档字符串完善（含参数、返回值、示例）
- ✅ 导出声明 `__all__` 已更新

### 影响与兼容性
- **向后兼容**：现有业务模块无需修改，新增组件为可选调用
- **无破坏性变更**：所有现有函数签名保持不变（仅新增可选参数）
- **性能影响**：新增函数为纯 Python 实现，无额外依赖，性能开销可忽略

### 下一步建议
1. **业务模块集成**：在 `pdf_processor.py` 自动换行逻辑中调用 `split_text_by_width`
2. **批量输出增强**：在 `data_handler.py` 批量处理时使用自定义输出目录功能
3. **单元测试补充**：为新增函数编写 pytest 测试用例（加入 `tests/test_components_text.py`）
4. **文档完善**：更新 README 的 "组件说明" 章节，添加新增函数的使用示例

### 相关文件
- 修改：`src/components.py`
- 测试：`temp/test_components_refactor.py`（已删除，测试通过）
- 文档：本文件

